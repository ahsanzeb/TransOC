(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 10.4' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     19452,        509]
NotebookOptionsPosition[     19100,        492]
NotebookOutlinePosition[     19524,        510]
CellTagsIndexPosition[     19481,        507]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"Jh", ":", " ", 
       StyleBox[
        RowBox[{"\[CapitalPi]", " ", "+", " ", 
         RowBox[{"A", "[", 
          RowBox[{"N", ",", "m"}], "]"}]}],
        FontSize->12]}], 
      StyleBox[" ",
       FontSize->12], 
      StyleBox["\[Rule]",
       FontSize->12], 
      StyleBox[" ",
       FontSize->12], 
      StyleBox[
       RowBox[{"\[CapitalPi]", " ", "+", " ", "D", "+", " ", 
        RowBox[{"A", "[", 
         RowBox[{
          RowBox[{"N", "-", "1"}], ",", 
          RowBox[{"m", "-", "1"}]}], "]"}]}],
       FontSize->12]}], 
     StyleBox[";",
      FontSize->12], 
     StyleBox["\[IndentingNewLine]",
      FontSize->12], 
     StyleBox[
      RowBox[{
       RowBox[{"Jl", ":", " ", 
        RowBox[{"\[CapitalPi]", " ", "+", " ", 
         RowBox[{"A", "[", 
          RowBox[{"N", ",", "m"}], "]"}]}]}], " ", "\[Rule]", " ", 
       RowBox[{"\[CapitalPi]", " ", "+", " ", "D", "+", " ", 
        RowBox[{"A", "[", 
         RowBox[{
          RowBox[{"N", "-", "1"}], ",", "m"}], "]"}]}]}],
      FontSize->12], 
     StyleBox[";",
      FontSize->12], 
     StyleBox["\[IndentingNewLine]",
      FontSize->12], 
     StyleBox[
      RowBox[{"For", " ", "Phi", " ", "case"}],
      FontSize->12]}], 
    StyleBox[",",
     FontSize->12], 
    StyleBox[" ",
     FontSize->12], 
    StyleBox[
     RowBox[{
      RowBox[{
       RowBox[{"switch", " ", "Jh"}], " ", "&"}], " ", "Jl"}],
     FontSize->12]}], 
   StyleBox["\[IndentingNewLine]",
    FontSize->24], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"mapCA1", "[", 
      RowBox[{"N_", ",", "k_", ",", "n_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "x1", ",", "listi1", ",", "tab1", ",", "set1", ",", "listf", ",", 
         "set11"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"tab1", "=", 
         RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{"add", " ", "an", " ", "up", " ", 
           RowBox[{"site", ":", " ", 
            RowBox[{"final", " ", "\[Equal]", ">", "  ", "N"}]}]}], ",", 
          "k"}], " ", "*)"}], "\[IndentingNewLine]", 
        StyleBox[
         RowBox[{"(*", " ", 
          RowBox[{
           RowBox[{"exclude", " ", "k"}], "=", 
           RowBox[{"0", " ", "case"}]}], " ", "*)"}],
         FontSize->12], "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"k", ">", "0"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"listi1", "=", 
            RowBox[{"comb", "[", 
             RowBox[{
              RowBox[{"N", "-", "1"}], ",", 
              RowBox[{"k", "-", "1"}]}], "]"}]}], ";", " ", 
           "\[IndentingNewLine]", 
           RowBox[{"Do", "[", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"set1", "=", 
               RowBox[{"listi1", "[", 
                RowBox[{"[", "i", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
              
              RowBox[{"(*", " ", 
               RowBox[{
                RowBox[{
                "add", " ", "an", " ", "up", " ", "site", " ", "at", " ", 
                 "nth", " ", "position"}], ";", " ", 
                RowBox[{
                 RowBox[{"shift", " ", "n"}], "+", " ", 
                 RowBox[{
                 "labels", " ", "by", " ", "1", " ", "as", " ", "they", " ", 
                  "should", " ", "be"}]}]}], " ", "*)"}], 
              "\[IndentingNewLine]", 
              RowBox[{"set11", "=", 
               RowBox[{"set1", "/.", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"q_Integer", "/;", 
                   RowBox[{"q", "\[GreaterEqual]", " ", "n"}]}], "\[Rule]", 
                  RowBox[{"q", "+", "1"}]}], "}"}]}]}], ";", 
              RowBox[{"(*", " ", 
               RowBox[{
                RowBox[{
                 RowBox[{"shift", " ", "by"}], " ", "+", 
                 RowBox[{"1", " ", "all", " ", "labels"}]}], " ", 
                "\[GreaterEqual]", " ", 
                RowBox[{
                "n", " ", "to", " ", "make", " ", "room", " ", "for", " ", 
                 "n"}]}], "*)"}], "\[IndentingNewLine]", 
              RowBox[{"listf", "=", 
               RowBox[{"Sort", "[", 
                RowBox[{"Join", "[", 
                 RowBox[{"set11", ",", 
                  RowBox[{"{", "n", "}"}]}], "]"}], "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"x1", "=", 
               RowBox[{
                RowBox[{"c", "[", 
                 RowBox[{"N", ",", "k"}], "]"}], "-", 
                RowBox[{"Sum", "[", 
                 RowBox[{
                  RowBox[{"c", "[", 
                   RowBox[{
                    RowBox[{"N", "-", 
                    RowBox[{"listf", "[", 
                    RowBox[{"[", 
                    RowBox[{"p", "+", "1"}], "]"}], "]"}]}], ",", 
                    RowBox[{"k", "-", "p"}]}], "]"}], ",", 
                  RowBox[{"{", 
                   RowBox[{"p", ",", "0", ",", 
                    RowBox[{"k", "-", "1"}]}], "}"}]}], "]"}]}]}], ";", " ", 
              RowBox[{"(*", " ", 
               RowBox[{
               "for", " ", "adding", " ", "an", " ", "up", " ", "site"}], " ",
                "*)"}], "\[IndentingNewLine]", 
              RowBox[{"AppendTo", "[", 
               RowBox[{"tab1", ",", "x1"}], "]"}], ";"}], 
             "\[IndentingNewLine]", ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", "1", ",", 
               RowBox[{"Length", "[", "listi1", "]"}]}], "}"}]}], "]"}], 
           ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
        "tab1"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"mapCA2", "[", 
      RowBox[{"N_", ",", "k_", ",", "n_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "x2", ",", "listi2", ",", "tab2", ",", "set2", ",", "listf", ",", 
         "set11"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"tab2", "=", 
         RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{"add", " ", "a", " ", "down", " ", 
           RowBox[{"site", ":", " ", 
            RowBox[{"final", " ", "\[Equal]", ">", "  ", "N"}]}]}], ",", 
          "k"}], " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"listi2", "=", 
         RowBox[{"comb", "[", 
          RowBox[{
           RowBox[{"N", "-", "1"}], ",", "k"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Do", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"set2", "=", 
            RowBox[{"listi2", "[", 
             RowBox[{"[", "i", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"set11", "=", 
            RowBox[{"set2", "/.", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"q_Integer", "/;", 
                RowBox[{"q", "\[GreaterEqual]", " ", "n"}]}], "\[Rule]", 
               RowBox[{"q", "+", "1"}]}], "}"}]}]}], ";", 
           RowBox[{"(*", " ", 
            RowBox[{
             RowBox[{
              RowBox[{"shift", " ", "by"}], " ", "+", 
              RowBox[{"1", " ", "all", " ", "labels"}]}], " ", 
             "\[GreaterEqual]", " ", 
             RowBox[{
             "n", " ", "to", " ", "make", " ", "room", " ", "for", " ", 
              "n"}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"x2", "=", 
            RowBox[{
             RowBox[{"c", "[", 
              RowBox[{"N", ",", "k"}], "]"}], "-", 
             RowBox[{"Sum", "[", 
              RowBox[{
               RowBox[{"c", "[", 
                RowBox[{
                 RowBox[{"N", "-", 
                  RowBox[{"set2", "[", 
                   RowBox[{"[", 
                    RowBox[{"p", "+", "1"}], "]"}], "]"}]}], ",", 
                 RowBox[{"k", "-", "p"}]}], "]"}], ",", 
               RowBox[{"{", 
                RowBox[{"p", ",", "0", ",", 
                 RowBox[{"k", "-", "1"}]}], "}"}]}], "]"}]}]}], ";", " ", 
           RowBox[{"(*", " ", 
            RowBox[{
            "for", " ", "adding", " ", "a", " ", "down", " ", "site"}], " ", 
            "*)"}], "\[IndentingNewLine]", 
           RowBox[{"AppendTo", "[", 
            RowBox[{"tab2", ",", "x2"}], "]"}], ";"}], "\[IndentingNewLine]", 
          ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", 
            RowBox[{"Length", "[", "listi2", "]"}]}], "}"}]}], "]"}], ";", 
        "\[IndentingNewLine]", "tab2"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"makeHtCA", "[", 
      RowBox[{"N_", ",", "m_", ",", "n_"}], "]"}], ":=", 
     RowBox[{"Module", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "pntr0", ",", "pntr1", ",", "pntr2", ",", "ntot0", ",", "ntot2", ",", 
         "Hta", ",", "Htb", ",", "coora", ",", "coorb", ",", "ntot1", ",", 
         "Htsph", ",", "Htspl", ",", "tab1", ",", "tab2", ",", "ind1", ",", 
         "ind2", ",", "ind01", ",", "ind02"}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"pointers", " ", "for", " ", "start", " ", "index"}], " ", 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"pntr0", "=", 
         RowBox[{"Insert", "[", 
          RowBox[{
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"Sum", "[", 
              RowBox[{
               RowBox[{"c", "[", 
                RowBox[{"N", ",", "j"}], "]"}], ",", 
               RowBox[{"{", 
                RowBox[{"j", ",", "0", ",", "i"}], "}"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", "0", ",", 
               RowBox[{"Min", "[", 
                RowBox[{"m", ",", "N"}], "]"}]}], "}"}]}], "]"}], ",", "0", 
           ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"pntr1", "=", 
         RowBox[{"Insert", "[", 
          RowBox[{
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"Sum", "[", 
              RowBox[{
               RowBox[{"c", "[", 
                RowBox[{
                 RowBox[{"N", "-", "1"}], ",", "j"}], "]"}], ",", 
               RowBox[{"{", 
                RowBox[{"j", ",", "0", ",", "i"}], "}"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", "0", ",", 
               RowBox[{"Min", "[", 
                RowBox[{
                 RowBox[{"m", "-", "1"}], ",", 
                 RowBox[{"N", "-", "1"}]}], "]"}]}], "}"}]}], "]"}], ",", "0",
            ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"pntr2", "=", 
         RowBox[{"Insert", "[", 
          RowBox[{
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"Sum", "[", 
              RowBox[{
               RowBox[{"c", "[", 
                RowBox[{
                 RowBox[{"N", "-", "1"}], ",", "j"}], "]"}], ",", 
               RowBox[{"{", 
                RowBox[{"j", ",", "0", ",", "i"}], "}"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", "0", ",", 
               RowBox[{"Min", "[", 
                RowBox[{"m", ",", 
                 RowBox[{"N", "-", "1"}]}], "]"}]}], "}"}]}], "]"}], ",", "0",
            ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"ntot0", "=", 
         RowBox[{"pntr0", "[", 
          RowBox[{"[", 
           RowBox[{"-", "1"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"ntot1", "=", 
         RowBox[{"pntr1", "[", 
          RowBox[{"[", 
           RowBox[{"-", "1"}], "]"}], "]"}]}], ";", 
        RowBox[{"ntot2", "=", 
         RowBox[{"pntr2", "[", 
          RowBox[{"[", 
           RowBox[{"-", "1"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Hta", "=", 
         RowBox[{"{", "}"}]}], ";", 
        RowBox[{"Htb", "=", 
         RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Do", "[", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
          "indices", " ", "list", " ", "of", " ", "initial", " ", "states"}], 
          " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"tab1", "=", 
            RowBox[{"mapCA1", "[", 
             RowBox[{"N", ",", "k", ",", "n"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"ind01", "=", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"pntr0", "[", 
                RowBox[{"[", 
                 RowBox[{"k", "+", "1"}], "]"}], "]"}], "+", "tab1"}], "}"}], 
             "//", "Transpose"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
            "indices", " ", "list", " ", "of", " ", "final", " ", "states"}], 
            " ", "*)"}], "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{"m", "-", 
             RowBox[{"1", " ", 
              RowBox[{"case", ":", " ", 
               RowBox[{"up", " ", "removed"}]}]}]}], " ", "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"k", ">", "0"}], "&&", 
              RowBox[{
               RowBox[{"Length", "[", "ind01", "]"}], ">", "0"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"ind1", "=", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"pntr1", "[", 
                   RowBox[{"[", "k", "]"}], "]"}], "+", 
                  RowBox[{"Table", "[", 
                   RowBox[{"i", ",", 
                    RowBox[{"{", 
                    RowBox[{"i", ",", "1", ",", 
                    RowBox[{"c", "[", 
                    RowBox[{
                    RowBox[{"N", "-", "1"}], ",", 
                    RowBox[{"k", "-", "1"}]}], "]"}]}], "}"}]}], "]"}]}], 
                 "}"}], "//", "Transpose"}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"coora", "=", 
               RowBox[{"Join", "[", 
                RowBox[{"ind01", ",", "ind1", ",", "2"}], "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"AppendTo", "[", 
               RowBox[{"Hta", ",", "coora"}], " ", "]"}], ";"}]}], 
            "\[IndentingNewLine]", "]"}], ";"}], "\[IndentingNewLine]", ",", 
          RowBox[{"{", 
           RowBox[{"k", ",", "0", ",", 
            RowBox[{"Min", "[", 
             RowBox[{"m", ",", "N"}], "]"}]}], "}"}]}], "]"}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"Do", "[", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
          "indices", " ", "list", " ", "of", " ", "initial", " ", "states"}], 
          " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"tab2", "=", 
            RowBox[{"mapCA2", "[", 
             RowBox[{"N", ",", "k", ",", "n"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"ind02", "=", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"pntr0", "[", 
                RowBox[{"[", 
                 RowBox[{"k", "+", "1"}], "]"}], "]"}], "+", "tab2"}], "}"}], 
             "//", "Transpose"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{"m", " ", 
             RowBox[{"case", ":", " ", 
              RowBox[{"down", " ", "removed"}]}]}], " ", "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Length", "[", "ind02", "]"}], ">", "0"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"ind2", "=", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"pntr2", "[", 
                   RowBox[{"[", 
                    RowBox[{"k", "+", "1"}], "]"}], "]"}], "+", 
                  RowBox[{"Table", "[", 
                   RowBox[{"i", ",", 
                    RowBox[{"{", 
                    RowBox[{"i", ",", "1", ",", 
                    RowBox[{"c", "[", 
                    RowBox[{
                    RowBox[{"N", "-", "1"}], ",", "k"}], "]"}]}], "}"}]}], 
                   "]"}]}], "}"}], "//", "Transpose"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"coorb", "=", 
               RowBox[{"Join", "[", 
                RowBox[{"ind02", ",", "ind2", ",", "2"}], "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"AppendTo", "[", 
               RowBox[{"Htb", ",", "coorb"}], " ", "]"}], ";"}]}], 
            "\[IndentingNewLine]", "]"}], ";"}], "\[IndentingNewLine]", ",", 
          RowBox[{"{", 
           RowBox[{"k", ",", "0", ",", 
            RowBox[{"Min", "[", 
             RowBox[{"m", ",", 
              RowBox[{"N", "-", "1"}]}], "]"}]}], "}"}]}], "]"}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"Htsph", "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Flatten", "[", 
             RowBox[{"Hta", ",", "1"}], "]"}], "\[Rule]", " ", "1"}], ",", 
           RowBox[{"{", 
            RowBox[{"ntot0", ",", "ntot1"}], "}"}]}], "]"}]}], ";", " ", 
        RowBox[{"(*", " ", 
         RowBox[{"Jh", " ", "for", " ", "D"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"Htspl", "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Flatten", "[", 
             RowBox[{"Htb", ",", "1"}], "]"}], "\[Rule]", " ", "1"}], ",", 
           RowBox[{"{", 
            RowBox[{"ntot0", ",", "ntot2"}], "}"}]}], "]"}]}], ";", " ", 
        RowBox[{"(*", " ", 
         RowBox[{"Jl", " ", "for", " ", "D"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"Htsph", ",", "Htspl"}], "}"}]}]}], "\[IndentingNewLine]", 
      "]"}]}], ";"}]}]}]], "Input",
 InitializationCell->True]
},
FileChangeProtection->Automatic,
AutoGeneratedPackage->Automatic,
WindowSize->{808, 706},
WindowMargins->{{76, Automatic}, {36, Automatic}},
FrontEndVersion->"10.4 for Mac OS X x86 (32-bit, 64-bit Kernel) (February 25, \
2016)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 18538, 470, 1338, "Input",
 InitializationCell->True]
}
]
*)

